<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>B·∫£n ƒë·ªì check-in</title>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --marker-bg:#2563eb;
    }
    html,body{
      margin:0;
      padding:0;
      height:100%;
      overflow:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    #map{
      position:fixed;
      inset:0;
      width:100%;
      height:100%;
    }

    /* Panel l·ªçc h√†ng ngang */
    .map-controls{
      position:fixed;
      top:10px;
      left:10px;
      z-index:1000;
      background:rgba(255,255,255,0.95);
      border-radius:12px;
      padding:6px 8px;
      box-shadow:0 10px 20px rgba(15,23,42,0.18);
      display:flex;
      align-items:center;
      gap:6px;
      font-size:12px;
    }
    .map-controls input,
    .map-controls select{
      font-size:12px;
      padding:3px 6px;
      border-radius:8px;
      border:1px solid #d1d5db;
      background:#f9fafb;
      height:28px;
    }

    /* Badge ƒë·∫øm */
    .count-badge{
      background:#2563eb;
      color:#fff;
      padding:3px 8px;
      border-radius:10px;
      font-size:12px;
      font-weight:600;
      margin-left:4px;
    }

    /* Marker ƒë√°nh s·ªë */
    .num-marker{
      background:var(--marker-bg);
      color:#fff;
      width:26px;
      height:26px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:600;
      border:2px solid #ffffff;
      box-shadow:0 0 0 1px rgba(15,23,42,0.25), 0 6px 10px rgba(15,23,42,0.3);
    }

    @media (max-width:640px){
      .map-controls{
        left:8px;
        right:8px;
        gap:4px;
      }
      .map-controls input,
      .map-controls select{
        font-size:11px;
        padding:2px 5px;
        height:26px;
      }
      .num-marker{
        width:24px;height:24px;font-size:11px;
      }
    }
  </style>
</head>

<body>

  <!-- Panel l·ªçc -->
  <div class="map-controls">
    <input type="date" id="dateFilter" />
    <select id="shiftFilter">
      <option value="">C·∫£ ng√†y</option>
      <option value="morning">S√°ng</option>
      <option value="afternoon">Chi·ªÅu</option>
    </select>
    <select id="nvFilter">
      <option value="">T·∫•t c·∫£</option>
    </select>
    <span id="countBadge" class="count-badge">0</span>
  </div>

  <div id="map"></div>

<script>
const ROW_CACHE_KEY = 'nv_checkin_last_rows';

(function init(){
  let rawRows = [];
  try{
    rawRows = JSON.parse(localStorage.getItem(ROW_CACHE_KEY)) || [];
  }catch(_){}

  if(!rawRows.length){
    alert('Kh√¥ng c√≥ d·ªØ li·ªáu check-in.');
    return;
  }

  // Map
  const map = L.map('map').setView([20.85,106.68], 12);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap & CARTO'
  }).addTo(map);

  const dateFilter   = document.getElementById('dateFilter');
  const shiftFilter  = document.getElementById('shiftFilter');
  const nvFilter     = document.getElementById('nvFilter');
  const countBadge   = document.getElementById('countBadge');

  // Parse ng√†y dd/MM/yyyy HH:mm
  function parseNgay(ngayRaw){
    if(!ngayRaw) return { ymd:null, hour:null };
    const [dmy, hms] = ngayRaw.split(" ");
    const [d,m,y] = dmy.split("/");
    const ymd = `${y}-${m.padStart(2,"0")}-${d.padStart(2,"0")}`;
    const hour = hms ? parseInt(hms.split(":")[0]) : null;
    return { ymd, hour };
  }

  const points = [];
  const markers = [];

  // ==========================
  //  CHU·∫®N B·ªä ƒêO KHO·∫¢NG C√ÅCH
  // ==========================
  let measurePoints = [];          // [{latlng, index}]
  let measureLine = null;

  const resultDiv = L.control({ position: "topright" });
  resultDiv.onAdd = function () {
    this._div = L.DomUtil.create("div", "measure-result");
    this._div.style =
      "background: rgba(255,255,255,0.9); padding:8px 12px; border-radius:8px; font-size:13px; box-shadow:0 2px 6px rgba(0,0,0,0.2); display:none;";
    this._div.innerHTML = "";
    return this._div;
  };
  resultDiv.addTo(map);

  function updateMeasureUI(text) {
    resultDiv._div.style.display = "block";
    resultDiv._div.innerHTML = "<b>" + text + "</b>";
  }

  function resetMeasure() {
    measurePoints = [];
    if (measureLine) {
      map.removeLayer(measureLine);
      measureLine = null;
    }
    resultDiv._div.style.display = "none";
  }
  // ==========================

  rawRows.forEach((r, idx)=>{
    if(!r.lat || !r.lng) return;
    const lat = parseFloat(r.lat);
    const lng = parseFloat(r.lng);
    if(isNaN(lat)||isNaN(lng)) return;

    const { ymd, hour } = parseNgay(r.ngay);
    const stt = idx + 1;

    const icon = L.divIcon({
      html: `<div class="num-marker">${stt}</div>`,
      className:'num-marker-wrap',
      iconSize:[26,26],
      iconAnchor:[13,13]
    });

    const mk = L.marker([lat,lng], {icon}).bindPopup(`
      <b>${stt}. ${r.ten_kh || r.ma_kh || ""}</b><br>
      Ng√†y: ${r.ngay}<br>
      ƒê·ªãa ch·ªâ: ${r.dia_chi || ""}<br>
      NV: ${r.ten_nv || r.ma_nv || ""}
    `);

    mk.addTo(map);

    // üëâ CLICK V√ÄO MARKER ƒê·ªÇ ƒêO KHO·∫¢NG C√ÅCH
    mk.on("click", function () {
      const latlng = mk.getLatLng();

      // N·∫øu ƒë√£ ch·ªçn 2 ƒëi·ªÉm r·ªìi th√¨ reset v√† b·∫Øt ƒë·∫ßu l·∫°i
      if (measurePoints.length === 2) {
        resetMeasure();
      }

      measurePoints.push({ latlng, index: stt });

      if (measurePoints.length === 1) {
        // M·ªõi ch·ªçn ƒëi·ªÉm ƒë·∫ßu
        updateMeasureUI("ƒê√£ ch·ªçn ƒëi·ªÉm ƒë·∫ßu: #" + stt);
      } else if (measurePoints.length === 2) {
        // ƒê√£ c√≥ 2 ƒëi·ªÉm ‚Üí t√≠nh kho·∫£ng c√°ch
        const a = measurePoints[0];
        const b = measurePoints[1];

        if (measureLine) {
          map.removeLayer(measureLine);
        }
        measureLine = L.polyline([a.latlng, b.latlng], {
          color: "#111",
          weight: 3,
          dashArray: "6,4"
        }).addTo(map);

        const km = a.latlng.distanceTo(b.latlng) / 1000;
        const kmText = km.toFixed(2) + " km";

        updateMeasureUI(
          "T·ª´ ƒëi·ªÉm #" + a.index + " ‚Üí #" + b.index + ": " + kmText
        );
      }
    });

    markers.push(mk);
    points.push({
      row:r, marker:mk,
      dateYmd:ymd, hour,
      ma_nv:r.ma_nv || "",
      stt
    });
  });

  // Fit map khi load
  if(markers.length){
    const grp = L.featureGroup(markers);
    map.fitBounds(grp.getBounds(), {padding:[40,40]});
  }

  // Danh s√°ch NV
  const nvSet = new Map();
  points.forEach(p=>{
    if(p.ma_nv && !nvSet.has(p.ma_nv)) nvSet.set(p.ma_nv, p.row.ten_nv || "");
  });
  nvSet.forEach((ten,ma)=>{
    const opt=document.createElement("option");
    opt.value=ma;
    opt.textContent=ten?`${ma} - ${ten}`:ma;
    nvFilter.appendChild(opt);
  });

  function applyFilter(){
    const fDate = dateFilter.value || "";
    const fShift= shiftFilter.value;
    const fNv   = nvFilter.value;

    const visible = [];

    points.forEach(p=>{
      let ok=true;

      if(fDate && p.dateYmd!==fDate) ok=false;

      if(ok && fShift){
        if(p.hour!=null){
          if(fShift==="morning" && p.hour>=12) ok=false;
          if(fShift==="afternoon" && p.hour<12) ok=false;
        }
      }

      if(ok && fNv){
        if(p.ma_nv!==fNv) ok=false;
      }

      if(ok){
        if(!map.hasLayer(p.marker)) p.marker.addTo(map);
        visible.push(p.marker);
      }else{
        if(map.hasLayer(p.marker)) map.removeLayer(p.marker);
      }
    });

    countBadge.textContent = visible.length;

    if(visible.length){
      const grp = L.featureGroup(visible);
      map.fitBounds(grp.getBounds(), {padding:[40,40]});
    }

    // Khi l·ªçc l·∫°i n√™n reset ƒëo kho·∫£ng c√°ch
    resetMeasure();
  }

  dateFilter.addEventListener("change", applyFilter);
  shiftFilter.addEventListener("change", applyFilter);
  nvFilter.addEventListener("change", applyFilter);

  countBadge.textContent = markers.length;
})();
</script>

</body>
</html>
