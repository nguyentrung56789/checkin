<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>B·∫£n ƒë·ªì check-in</title>

  <!-- Leaflet Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --topbar-h: 52px; /* chi·ªÅu cao thanh tr√™n c√πng */
    }
    html,body{
      margin:0;
      padding:0;
      height:100%;
      overflow:hidden;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }

    /* Map chi·∫øm to√†n b·ªô ph·∫ßn d∆∞·ªõi top-bar, t·ª± co gi√£n theo m√†n h√¨nh ƒêT */
    #map{
      position:fixed;
      top:var(--topbar-h);
      left:0;
      right:0;
      bottom:0;
      width:100%;
      height:auto;
    }

    .top-bar{
      position:fixed;
      top:0;left:0;right:0;
      height:var(--topbar-h);
      padding:10px 14px;
      box-sizing:border-box;
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(6px);
      display:flex;
      align-items:center;
      justify-content:space-between;
      z-index:999;
      border-bottom:1px solid #e5e7eb;
    }
    .title{
      font-size:16px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .btn{
      padding:6px 14px;
      border:none;
      border-radius:999px;
      background:#2563eb;
      color:white;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
    }

    @media (max-width:640px){
      .title{ font-size:15px; }
      .btn{
        padding:5px 12px;
        font-size:12px;
      }
      :root{
        --topbar-h: 48px; /* h∆°i th·∫•p h∆°n tr√™n m√†n nh·ªè */
      }
    }
  </style>
</head>

<body>

  <!-- Thanh ti√™u ƒë·ªÅ -->
  <div class="top-bar">
    <div class="title">üìç B·∫£n ƒë·ªì check-in</div>
    <button class="btn" onclick="history.back()">‚¨Ö Quay l·∫°i</button>
  </div>

  <div id="map"></div>

<script>
const ROW_CACHE_KEY = 'nv_checkin_last_rows';

(function init(){
  // 1. L·∫•y d·ªØ li·ªáu ƒë√£ l·ªçc t·ª´ localStorage
  let rows = [];
  try{
    const raw = localStorage.getItem(ROW_CACHE_KEY);
    if(raw){
      rows = JSON.parse(raw) || [];
    }
  }catch(_){}

  if(!rows || !rows.length){
    alert('Kh√¥ng c√≥ d·ªØ li·ªáu check-in. Vui l√≤ng m·ªü t·ª´ trang b√°o c√°o sau khi ƒë√£ l·ªçc.');
    return;
  }

  // 2. Kh·ªüi t·∫°o map (t√¢m m·∫∑c ƒë·ªãnh ‚Äì c√≥ th·ªÉ ch·ªânh)
  const map = L.map('map').setView([20.85,106.68], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19
  }).addTo(map);

  // 3. V·∫Ω marker t·ª´ d·ªØ li·ªáu ƒë√£ l·ªçc
  const markers = [];

  rows.forEach(r=>{
    if(!r.lat || !r.lng) return;
    const lat = parseFloat(r.lat);
    const lng = parseFloat(r.lng);
    if(isNaN(lat) || isNaN(lng)) return;

    const tenKh   = r.ten_kh || r.ma_kh || '';
    const ngay    = r.ngay || '';
    const diaChi  = r.dia_chi || '---';
    const nhanVien= r.ten_nv || r.ma_nv || '';

    const mk = L.marker([lat,lng]).addTo(map)
      .bindPopup(`
        <b>${tenKh}</b><br>
        Ng√†y: ${ngay}<br>
        ƒê·ªãa ch·ªâ: ${diaChi}<br>
        NV: ${nhanVien}
      `);

    markers.push(mk);
  });

  if(markers.length){
    const grp = L.featureGroup(markers);
    map.fitBounds(grp.getBounds(), {padding:[40,40]});
  }else{
    alert('Kh√¥ng c√≥ ƒëi·ªÉm n√†o c√≥ to·∫° ƒë·ªô (lat/lng) ƒë·ªÉ hi·ªÉn th·ªã tr√™n b·∫£n ƒë·ªì.');
  }
})();
</script>

</body>
</html>
