<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Danh s√°ch kh√°ch h√†ng (nv_checkin_khach_hang)</title>

  <style>
    :root{
      --bg:#0b1020;
      --panel:#12182b;
      --muted:#8aa0b6;
      --text:#e9f0f6;
      --accent:#4da3ff;
      --ok:#22c55e;
      --warn:#f59e0b;
      --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif
    }
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:24px;margin:0 0 16px}

    .bar{
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .bar-left{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      flex:1;
      min-width:0;
    }

    .btn{
      padding:8px 12px;
      border:0;
      border-radius:12px;
      background:var(--panel);
      color:var(--text);
      cursor:pointer
    }
    .btn:hover{filter:brightness(1.08)}
    .btn-primary{background:var(--accent);color:#001226}
    .btn-ok{background:var(--ok);color:#02220f}
    .btn-warn{background:var(--warn)}

    /* N√∫t b·ªã kh√≥a (sau khi ƒë√£ checkin h√¥m nay) */
    .btn-disabled{
      background:#4b5563 !important;
      color:#cbd5f5 !important;
      cursor:not-allowed !important;
      opacity:.7;
      box-shadow:none !important;
      pointer-events:none;
    }

    .input{
      padding:8px 10px;
      background:#0f1628;
      border:1px solid #243153;
      color:var(--text);
      border-radius:12px
    }
    .muted{color:var(--muted);font-size:12px}
    .table{
      width:100%;
      border-collapse:collapse;
      background:var(--panel);
      border-radius:14px;
      overflow:hidden
    }
    thead th{
      font-weight:600;
      text-align:left;
      font-size:13px;
      color:var(--muted);
      background:#0f1628
    }
    th,td{
      padding:10px 12px;
      border-bottom:1px solid #19223c
    }
    tbody tr:hover{background:#0f1930}
    .col-actions{white-space:nowrap}

    /* N√öT M√É KH: xanh l√°, d·ªÖ b·∫•m */
    .ma-kh-btn{
      border:0;
      border-radius:999px;
      padding:6px 12px;
      background:var(--ok);
      color:#02220f;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 0 0 1px rgba(0,0,0,.25),0 6px 14px rgba(0,0,0,.4);
      transition:transform .06s ease, box-shadow .06s ease, filter .08s ease;
    }
    .ma-kh-btn:hover{
      filter:brightness(1.06);
    }
    .ma-kh-btn:active{
      transform:translateY(1px) scale(.97);
      box-shadow:0 2px 6px rgba(0,0,0,.55);
    }
    /* N√∫t m√£ KH ƒë√£ checkin h√¥m nay */
    .ma-kh-btn.ma-kh-disabled{
      background:#4b5563;
      color:#cbd5f5;
      cursor:default;
      box-shadow:none;
      opacity:.7;
    }
    .ma-kh-btn.ma-kh-disabled:hover,
    .ma-kh-btn.ma-kh-disabled:active{
      transform:none;
      filter:none;
    }

    .modal-wrap{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,.4);
      backdrop-filter:blur(2px);
      z-index:1000
    }
    .modal{
      width:min(560px,92vw);
      background:var(--panel);
      border:1px solid #1e2943;
      border-radius:16px;
      padding:16px
    }
    .modal h3{margin:0 0 12px;font-size:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .grid .span2{grid-column:1 / span 2}
    .row{display:flex;gap:8px;align-items:center}

    /* TOAST: hi·ªÉn th·ªã gi·ªØa m√†n h√¨nh */
    .toast{
      position:fixed;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      min-width:min(92vw,420px);
      text-align:center;
      background:#0f1628;
      border:1px solid #243153;
      padding:14px 18px;
      border-radius:16px;
      display:none;
      z-index:2000;
      box-shadow:0 14px 40px rgba(0,0,0,.6);
      font-size:15px;
    }
  </style>

  <!-- /js/internal_key.js c·∫ßn c√≥ getConfig('url'|'anon') v√† (tu·ª≥) getInternalKey() -->
  <script src="/js/internal_key.js"></script>
</head>
<body>
<div class="wrap">

  <div class="bar">
    <div class="bar-left">
      <button id="btnAdd" class="btn btn-primary">+ Th√™m</button>

      <!-- Dropdown ch·ªçn b√°n k√≠nh (m) -->
      <label class="row" style="gap:6px">
        <span class="muted">B√°n k√≠nh</span>
        <select id="radiusSelect" class="input">
          <option value="20">20m</option>
          <option value="50" selected>50m</option>
          <option value="100">100m</option>
          <option value="500">500m</option>
        </select>
      </label>
    </div>

    <!-- N√∫t m·ªü app_checkin -->
    <button id="btnOpenCheckin" class="btn btn-ok">
      üì∑ Checkin
    </button>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th style="width:160px">M√£ KH</th>
        <th>T√™n KH</th>
        <!-- ƒê√É B·ªé: c·ªôt ƒê·ªãa ch·ªâ -->
        <th style="width:160px">ƒêi·ªán tho·∫°i</th>
        <th class="col-actions" style="width:120px">Thao t√°c</th>
      </tr>
    </thead>
    <tbody id="tbody">
      <tr><td colspan="4" class="muted">ƒêang t·∫£i...</td></tr>
    </tbody>
  </table>

  <div id="countInfo" class="muted" style="margin-top:8px"></div>
</div>

<!-- Modal th√™m/s·ª≠a -->
<div class="modal-wrap" id="modalWrap">
  <div class="modal">
    <h3 id="modalTitle">Th√™m kh√°ch h√†ng</h3>
    <div class="grid">
      <label class="span2" id="maKhRow">M√£ KH (kh√≥a):
        <!-- readonly: nh√¨n ƒë∆∞·ª£c khi S·ª¨A nh∆∞ng kh√¥ng ƒë∆∞·ª£c g√µ -->
        <input id="f_ma_kh" class="input" readonly>
      </label>

      <label class="span2">T√™n KH: <input id="f_ten_kh" class="input" placeholder="VD: Nguy·ªÖn VƒÉn A"></label>
      <label class="span2">ƒê·ªãa ch·ªâ: <input id="f_dia_chi" class="input" placeholder="S·ªë nh√†, ƒë∆∞·ªùng..."></label>
      <label class="span2">ƒêi·ªán tho·∫°i: <input id="f_dien_thoai" class="input" placeholder="VD: 09xxxxxxxx"></label>
    </div>
    <div class="row" style="margin-top:12px">
      <button id="btnSave" class="btn btn-ok">L∆∞u</button>
      <button id="btnCancel" class="btn">H·ªßy</button>
      <span class="right muted" id="modalHint"></span>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ==== T·∫£i supabase-js n·∫øu ch∆∞a c√≥ ==== */
async function getSupabaseLib(){
  if (window.supabase?.createClient) return window.supabase;
  const mod = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm');
  return mod;
}

(async () => {
  const $  = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  const toast = (msg,t='')=>{
    const el = $('#toast');
    el.textContent = msg;
    el.style.display = 'block';
    el.style.borderColor =
      t==='err' ? '#ef4444' :
      t==='ok'  ? '#22c55e' :
                  '#243153';
    clearTimeout(toast._t);
    toast._t = setTimeout(()=>el.style.display='none',2200);
  };

  // helper escape attribute (cho data-*)
  function escAttr(v){
    return String(v ?? '')
      .replace(/&/g,'&amp;')
      .replace(/"/g,'&quot;')
      .replace(/</g,'&lt;');
  }

  const TABLE           = 'nv_checkin_khach_hang';
  const SESSION_IMG_KEY = 'CHECKIN_IMAGE_PAYLOAD'; // ·∫¢nh l∆∞u t·ª´ trang camera

  // B·∫£ng log checkin
  const CHECKIN_TABLE    = 'nv_checkin';
  const CHECKIN_DATE_COL = 'ngay'; // text d·∫°ng dd/MM/yyyy hh:mm

  let SB            = null;
  let CURRENT       = null;
  let CHECKED_TODAY = false; // true = NV n√†y ƒë√£ checkin h√¥m nay (kh√≥a)

  // ===== Helpers chung =====
  function getLatLngFromURL(){
    const qp = new URLSearchParams(location.search);
    const latRaw = qp.get('lat') ?? qp.get('latitude');
    const lngRaw = qp.get('lng') ?? qp.get('long') ?? qp.get('lon') ?? qp.get('longitude');
    const lat = Number(latRaw), lng = Number(lngRaw);
    if (Number.isFinite(lat) && Number.isFinite(lng)) return { lat, lng };
    return null;
  }

  function initRadiusFromURLOrDefault(){
    const sel = $('#radiusSelect');
    const qp = new URLSearchParams(location.search);
    let r = Number(qp.get('radius'));        // m√©t
    const rkm = Number(qp.get('radius_km')); // km
    if (Number.isFinite(rkm) && rkm > 0) r = rkm * 1000;
    if (!Number.isFinite(r) || r <= 0) r = 50; // m·∫∑c ƒë·ªãnh 50m
    if ([20,50,100,500].includes(Math.round(r))){
      sel.value = String(Math.round(r));
    } else {
      sel.value = '50';
    }
  }

  function getRadiusFromUI(){
    const v = Number($('#radiusSelect').value);
    return Number.isFinite(v) && v>0 ? v : 50;
  }

  function getCurrentNVID(){
    try{
      const s = sessionStorage.getItem('nv_ctx');
      if (s){
        const o = JSON.parse(s);
        if (o?.ma_nv) return String(o.ma_nv);
      }
    }catch{}
    try{
      const s2 = localStorage.getItem('nv');
      if (s2){
        const o2 = JSON.parse(s2);
        if (o2?.ma_nv) return String(o2.ma_nv);
      }
    }catch{}
    return null;
  }

  function getCurrentNVName(){
    try{
      const s = sessionStorage.getItem('nv_ctx');
      if (s){
        const o = JSON.parse(s);
        if (o?.ten_nv) return String(o.ten_nv);
      }
    }catch{}
    try{
      const s2 = localStorage.getItem('nv');
      if (s2){
        const o2 = JSON.parse(s2);
        if (o2?.ten_nv) return String(o2.ten_nv);
      }
    }catch{}
    return null;
  }

  function getImagePayloadFromSession(){
    try{
      const raw = sessionStorage.getItem(SESSION_IMG_KEY);
      if (!raw) return null;
      const p = JSON.parse(raw);
      if (p && typeof p.image_b64 === 'string' && p.image_b64.length > 0){
        return p; // { image_mime, image_b64, ma_kh?, ma_hd? }
      }
    }catch{}
    return null;
  }

  // fallback cho CSS.escape
  function cssEscapeSafe(v){
    try{
      return CSS && CSS.escape ? CSS.escape(v) : String(v).replace(/"/g,'\\"');
    }catch{
      return String(v).replace(/"/g,'\\"');
    }
  }

  // ==== H·ªó tr·ª£ ng√†y h√¥m nay (dd/MM/yyyy) ====
  function getTodayPrefix_ddMMyyyy(){
    const d = new Date();
    const dd = String(d.getDate()).padStart(2,'0');
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    return `${dd}/${mm}/${yyyy}`;
  }

  // ===== Kh√≥a / m·ªü kh√≥a n√∫t theo CHECKED_TODAY =====
  function applyCheckedTodayLock(){
    const btnAdd = $('#btnAdd');
    if (btnAdd){
      if (CHECKED_TODAY){
        btnAdd.classList.add('btn-disabled');
        btnAdd.disabled = true;
      }else{
        btnAdd.classList.remove('btn-disabled');
        btnAdd.disabled = false;
      }
    }

    $$('#tbody .btn-edit').forEach(b=>{
      if (CHECKED_TODAY){
        b.classList.add('btn-disabled');
        b.disabled = true;
      }else{
        b.classList.remove('btn-disabled');
        b.disabled = false;
      }
    });
  }

  // ==== Ki·ªÉm tra xem NV hi·ªán t·∫°i ƒë√£ checkin h√¥m nay ch∆∞a ====
  async function loadCheckedToday(){
    CHECKED_TODAY = false;

    const ma_nv = getCurrentNVID();
    if (!ma_nv) return;

    const todayPrefix = getTodayPrefix_ddMMyyyy(); // dd/MM/yyyy

    const { data, error } = await SB
      .from(CHECKIN_TABLE)
      .select(`ma_nv, ${CHECKIN_DATE_COL}`)
      .eq('ma_nv', ma_nv)
      .like(CHECKIN_DATE_COL, todayPrefix + '%');

    if (!error && Array.isArray(data) && data.length > 0){
      CHECKED_TODAY = true;
    }else{
      CHECKED_TODAY = false;
    }

    console.log('CHECKED_TODAY?', CHECKED_TODAY);
  }

  // ===== Webhook URL (g·∫Øn c·ª©ng) =====
  function getWebhookURL(){
    return 'https://dhsybbqoe.datadex.vn/webhook/hoadon';
  }

  // ===== G·ª≠i webhook: POST JSON tr∆∞·ªõc, n·∫øu 405 th√¨ fallback GET =====
  async function postWebhook(payload){
    const url = getWebhookURL();
    const headers = { 'content-type':'application/json' };
    try{
      if (typeof getInternalKey === 'function'){
        headers['x-internal-key'] = getInternalKey();
      }
    }catch{}

    try{
      const res = await fetch(url, { method:'POST', headers, body: JSON.stringify(payload) });
      const text = await res.text().catch(()=> '');
      if (res.ok) return { ok:true, status:res.status, text };
      if (res.status !== 405) return { ok:false, status:res.status, text };
    }catch(e){}

    const qs = new URLSearchParams(Object.entries(payload).map(([k,v])=>[k, String(v ?? '')])).toString();
    const getUrl = url + (url.includes('?') ? '&' : '?') + qs;
    try{
      const res2 = await fetch(getUrl, { method:'GET', headers: { 'x-internal-key': headers['x-internal-key'] || '' } });
      const text2 = await res2.text().catch(()=> '');
      return { ok: res2.ok, status: res2.status, text: text2 };
    }catch(e2){
      return { ok:false, status:0, text:String(e2) };
    }
  }

  // ===== Modal =====
  function openModal(mode,row=null){
    CURRENT = { mode };
    $('#modalTitle').textContent = mode==='add' ? 'Th√™m kh√°ch h√†ng' : 'S·ª≠a kh√°ch h√†ng';
    $('#f_ma_kh').disabled = (mode==='edit');
    if (mode==='edit' && row){
      $('#f_ma_kh').value      = row.ma_kh || '';
      $('#f_ten_kh').value     = row.ten_kh || '';
      $('#f_dia_chi').value    = row.dia_chi || '';
      $('#f_dien_thoai').value = row.dien_thoai || '';
      CURRENT.ma_kh = row.ma_kh;
    }else{
      $('#f_ma_kh').value      = '';
      $('#f_ten_kh').value     = '';
      $('#f_dia_chi').value    = '';
      $('#f_dien_thoai').value = '';
    }
    $('#modalWrap').style.display = 'flex';
  }

  const closeModal = () => $('#modalWrap').style.display='none';

  // ===== Supabase client =====
  async function makeClient(){
    const url  = getConfig('url');
    const anon = getConfig('anon');
    const lib  = await getSupabaseLib();
    return lib.createClient(url,anon,{auth:{persistSession:false}});
  }

  // ===== List & render (kh√¥ng theo b√°n k√≠nh) =====
  async function loadData(){
    $('#tbody').innerHTML = `<tr><td colspan="4" class="muted">ƒêang t·∫£i...</td></tr>`;
    const { data, error, count } = await SB
      .from(TABLE)
      .select('ma_kh,ten_kh,dia_chi,dien_thoai',{count:'exact'})
      .order('ten_kh',{ascending:true})
      .limit(500);

    if (error){
      console.error(error);
      $('#tbody').innerHTML =
        `<tr><td colspan="4" class="muted">L·ªói Supabase: ${error.message}</td></tr>`;
      return;
    }
    $('#countInfo').textContent = `${count ?? (data?.length || 0)} d√≤ng`;
    renderRows(data || []);
  }

  function renderRows(rows){
    if (!rows.length){
      $('#tbody').innerHTML =
        `<tr><td colspan="4" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
    } else {
      const html = rows.map(r => {
        const disabled = CHECKED_TODAY === true;
        const btnHtml = disabled
          ? `<button class="ma-kh-btn ma-kh-disabled" disabled title="Nh√¢n vi√™n ƒë√£ checkin h√¥m nay">${r.ma_kh}</button>`
          : `<button class="ma-kh-btn" data-id="${escAttr(r.ma_kh)}">${r.ma_kh}</button>`;
        return `
      <tr data-id="${escAttr(r.ma_kh)}"
          data-ten_kh="${escAttr(r.ten_kh||'')}"
          data-dien_thoai="${escAttr(r.dien_thoai||'')}">

        <td class="col-ma">
          ${btnHtml}
        </td>
        <td class="col-ten">${r.ten_kh || ''}</td>
        <td class="col-phone">${r.dien_thoai || ''}</td>
        <td class="col-actions">
          <button class="btn btn-warn btn-edit">S·ª≠a</button>
        </td>
      </tr>`;
      }).join('');

      $('#tbody').innerHTML = html;
    }

    $$('#tbody .btn-edit').forEach(b =>
      b.addEventListener('click', onEditClick)
    );
    // ch·ªâ g·∫Øn click cho n√∫t ch∆∞a b·ªã kh√≥a
    $$('#tbody .ma-kh-btn:not(.ma-kh-disabled)').forEach(b =>
      b.addEventListener('click', () => onMaKHClick(b.dataset.id))
    );

    // √°p d·ª•ng tr·∫°ng th√°i kh√≥a cho n√∫t Th√™m + S·ª≠a
    applyCheckedTodayLock();
  }

  function onEditClick(e){
    const tr = e.target.closest('tr');
    if (!tr) return;
    const row = {
      ma_kh:      tr.getAttribute('data-id'),
      ten_kh:     tr.dataset.ten_kh || tr.children[1].textContent,
      dia_chi:    tr.dataset.dia_chi || '',
      dien_thoai: tr.dataset.dien_thoai || tr.children[2].textContent
    };
    openModal('edit', row);
  }

  // ===== Click M√£ KH ‚Üí g·ª≠i webhook (k√®m ·∫£nh base64 n·∫øu c√≥) =====
  async function onMaKHClick(ma_kh){
    const coords = getLatLngFromURL();
    if (!coords){
      toast('Thi·∫øu to·∫° ƒë·ªô lat/lng trong URL ‚Äî kh√¥ng th·ªÉ checkin','err');
      return;
    }
    const ma_nv  = getCurrentNVID();
    const ten_nv = getCurrentNVName();
    const img    = getImagePayloadFromSession();

    const payload = {
      action: 'checkin',
      ma_kh,
      ma_nv:  ma_nv  || null,
      ten_nv: ten_nv || null,
      lat: Number(coords.lat),
      lng: Number(coords.lng),
      image_mime: img?.image_mime || 'image/jpeg',
      image_b64:  img?.image_b64  || ''
    };

    try{
      const res = await postWebhook(payload);
      if (res.ok){
        // Sau khi checkin th√†nh c√¥ng: kh√≥a to√†n b·ªô
        CHECKED_TODAY = true;

        // kh√≥a n√∫t m√£ KH
        $$('.ma-kh-btn').forEach(btn=>{
          btn.classList.add('ma-kh-disabled');
          btn.disabled = true;
          btn.removeAttribute('data-id');
          btn.title = 'Nh√¢n vi√™n ƒë√£ checkin h√¥m nay';
        });

        // kh√≥a n√∫t Th√™m + S·ª≠a
        applyCheckedTodayLock();

        toast(`‚úÖ ƒê√É CHECK IN KH: ${ma_kh}`,'ok');
      } else {
        toast(`Webhook l·ªói ${res.status}: ${res.text?.slice(0,160)||'...'}`,'err');
      }
    }catch(err){
      console.error(err);
      toast('G·ª≠i webhook th·∫•t b·∫°i','err');
    }
  }

  // ===== T·ª∞ SINH M√É KH: yymmddhhmm =====
  function generateMaKH(){
    const d = new Date();
    const yy = String(d.getFullYear()).slice(-2);
    const MM = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    return yy + MM + dd + hh + mm;
  }

  // ===== KI·ªÇM TRA M√É KH TR√ôNG =====
  async function checkMaKHExists(ma_kh){
    const { data, error } = await SB
      .from(TABLE)
      .select('ma_kh')
      .eq('ma_kh', ma_kh)
      .limit(1);
    if (error){
      console.error('L·ªói check m√£ KH:', error);
      return false;
    }
    return Array.isArray(data) && data.length > 0;
  }

  // ===== L∆∞u: t·ª± l·∫•y lat/lng t·ª´ URL v√† l·ªçc l·∫°i theo b√°n k√≠nh =====
  async function saveForm(){
    let ma_kh      = $('#f_ma_kh').value.trim();
    const ten_kh     = $('#f_ten_kh').value.trim();
    const dia_chi    = $('#f_dia_chi').value.trim();
    const dien_thoai = $('#f_dien_thoai').value.trim();

    // ADD: n·∫øu ƒëang th√™m m·ªõi
    if (CURRENT?.mode === 'add'){
      // n·∫øu tr·ªëng -> t·ª± sinh
      if (!ma_kh){
        ma_kh = generateMaKH();
        $('#f_ma_kh').value = ma_kh;
        toast(`T·ª± sinh m√£ KH: ${ma_kh}`,'ok');
      }
      // ki·ªÉm tra tr√πng
      const exists = await checkMaKHExists(ma_kh);
      if (exists){
        toast(`‚ùå M√£ KH ${ma_kh} ƒë√£ t·ªìn t·∫°i, vui l√≤ng nh·∫≠p m√£ kh√°c ho·∫∑c ƒë·ªÉ tr·ªëng ƒë·ªÉ t·ª± sinh`,`err`);
        return;
      }
    } else {
      // EDIT: m√£ KH ƒëang disabled n√™n kh√¥ng ƒë·ªïi, nh∆∞ng n·∫øu v√¨ l√Ω do g√¨ ƒë√≥ tr·ªëng th√¨ ch·∫∑n
      if (!ma_kh){
        toast('M√£ KH kh√¥ng ƒë∆∞·ª£c tr·ªëng','err');
        return;
      }
    }

    const coords = getLatLngFromURL();
    const lat = coords?.lat ?? null;
    const lng = coords?.lng ?? null;

    if (CURRENT?.mode === 'add'){
      const { error } = await SB
        .from(TABLE)
        .insert([{ ma_kh, ten_kh, dia_chi, dien_thoai, lat, lng }]);
      if (error){
        console.error(error);
        toast('Th√™m th·∫•t b·∫°i','err');
        return;
      }
      toast('ƒê√£ th√™m','ok');
    } else {
      const { error } = await SB
        .from(TABLE)
        .update({ ten_kh, dia_chi, dien_thoai, lat, lng })
        .eq('ma_kh', CURRENT.ma_kh);
      if (error){
        console.error(error);
        toast('S·ª≠a th·∫•t b·∫°i','err');
        return;
      }
      toast('ƒê√£ l∆∞u','ok');
    }

    closeModal();
    if (coords){
      runNearby(coords.lat, coords.lng, getRadiusFromUI());
    } else {
      loadData();
    }
  }

  // ===== Nearby runner (l·ªçc theo lat/lng + radius) =====
  async function runNearby(lat, lng, radius){
    const $tbody = $('#tbody');
    $tbody.innerHTML =
      `<tr><td colspan="4" class="muted">ƒêang l·ªçc theo b√°n k√≠nh...</td></tr>`;

    const R = 6371000, d2r = Math.PI/180, latR = lat*d2r;
    const delta = (radius / R) * (180/Math.PI);
    const cosLat = Math.max(1e-6, Math.cos(latR));
    const minLat = lat - delta, maxLat = lat + delta;
    const minLng = lng - delta/cosLat;
    const maxLng = lng + delta/cosLat;

    const { data, error } = await SB
      .from(TABLE)
      .select('ma_kh,ten_kh,dia_chi,dien_thoai,lat,lng', { count:'exact' })
      .not('lat','is',null).not('lng','is',null)
      .gte('lat', minLat).lte('lat', maxLat)
      .gte('lng', minLng).lte('lng', maxLng)
      .limit(1000);

    if (error){
      console.error(error);
      toast('L·ªói truy v·∫•n Supabase','err');
      $('#tbody').innerHTML =
        `<tr><td colspan="4" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
      $('#countInfo').textContent = `0 d√≤ng (l·ªói truy v·∫•n)`;
      return;
    }

    const rows = (Array.isArray(data)?data:[])
      .map(r=>({ ...r, rlat:Number(r.lat), rlng:Number(r.lng) }))
      .filter(r=>Number.isFinite(r.rlat) && Number.isFinite(r.rlng));

    let nearby = rows.map(r=>{
      const dLat = (r.rlat - lat) * d2r;
      const dLng = (r.rlng - lng) * d2r;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(latR)*Math.cos(r.rlat*d2r)*Math.sin(dLng/2)**2;
      const dist = 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return { ...r, dist: Math.round(dist) };
    }).filter(r=>r.dist <= radius)
      .sort((a,b)=>a.dist - b.dist);

    if (nearby.length === 0){
      toast(`Kh√¥ng c√≥ KH trong ${(Math.round(radius/100)/10)} km`, 'info');
      $('#tbody').innerHTML =
        `<tr><td colspan="4" class="muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>`;
      $('#countInfo').textContent =
        `0 d√≤ng (l·ªçc ${Math.round(radius)}m)`;
    } else {
      toast(`T√¨m th·∫•y ${nearby.length} KH trong ${(Math.round(radius/100)/10)} km`, 'ok');
      const html = nearby.map(r=>{
        const disabled = CHECKED_TODAY === true;
        const btnHtml = disabled
          ? `<button class="ma-kh-btn ma-kh-disabled" disabled title="Nh√¢n vi√™n ƒë√£ checkin h√¥m nay">${r.ma_kh}</button>`
          : `<button class="ma-kh-btn" data-id="${escAttr(r.ma_kh)}">${r.ma_kh}</button>`;
        return `
        <tr data-id="${escAttr(r.ma_kh)}"
            data-ten_kh="${escAttr(r.ten_kh||'')}"
            data-dien_thoai="${escAttr(r.dien_thoai||'')}">

          <td class="col-ma">
            ${btnHtml}
          </td>
          <td class="col-ten">
            ${escAttr(r.ten_kh||'')}
            <span class="muted"> ‚Ä¢ ${r.dist}m</span>
          </td>
          <td class="col-phone">${r.dien_thoai || ''}</td>
          <td class="col-actions">
            <button class="btn btn-warn btn-edit">S·ª≠a</button>
          </td>
        </tr>`;
      }).join('');

      $('#tbody').innerHTML = html;
      $('#countInfo').textContent =
        `${nearby.length} d√≤ng (l·ªçc ${Math.round(radius)}m)`;

      $$('#tbody .btn-edit').forEach(b =>
        b.addEventListener('click', onEditClick)
      );
      $$('#tbody .ma-kh-btn:not(.ma-kh-disabled)').forEach(b =>
        b.addEventListener('click', () => onMaKHClick(b.dataset.id))
      );

      // √°p d·ª•ng tr·∫°ng th√°i kh√≥a
      applyCheckedTodayLock();
    }
  }

  // ===== events =====
  $('#btnAdd').addEventListener('click',()=>openModal('add'));
  $('#btnCancel').addEventListener('click',closeModal);
  $('#btnSave').addEventListener('click',saveForm);

  // N√∫t m·ªü app_checkin.html
  const btnOpenCheckin = $('#btnOpenCheckin');
  if (btnOpenCheckin){
    btnOpenCheckin.addEventListener('click', ()=>{
      location.assign('app_checkin.html');
    });
  }

  // ƒê·ªïi b√°n k√≠nh ‚Üí l·ªçc l·∫°i
  $('#radiusSelect').addEventListener('change',()=>{
    const coords = getLatLngFromURL();
    const r = getRadiusFromUI();
    if (coords) runNearby(coords.lat, coords.lng, r);
    else toast('Thi·∫øu to·∫° ƒë·ªô lat/lng trong URL ƒë·ªÉ l·ªçc theo b√°n k√≠nh', 'err');
  });

  // ======================= init =======================
  try{
    SB = await makeClient();

    // Ki·ªÉm tra: NV hi·ªán t·∫°i ƒë√£ checkin h√¥m nay ch∆∞a?
    await loadCheckedToday();

    // √°p d·ª•ng kh√≥a cho n√∫t Th√™m (tr∆∞·ªõc khi render b·∫£ng)
    applyCheckedTodayLock();

    initRadiusFromURLOrDefault();

    const coords = getLatLngFromURL();
    if (coords){
      const r = getRadiusFromUI();
      toast(`lat=${coords.lat.toFixed(6)} ‚Ä¢ lng=${coords.lng.toFixed(6)} ‚Ä¢ r=${Math.round(r)}m`, 'ok');
      runNearby(coords.lat, coords.lng, r);
    }else{
      loadData();
    }
  }catch(e){
    console.error(e);
    $('#tbody').innerHTML =
      `<tr><td colspan="4" class="muted">L·ªói kh·ªüi t·∫°o: ${e.message}</td></tr>`;
  }
})();
</script>

</body>
</html>
